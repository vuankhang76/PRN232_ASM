using BusinessObjects;
using Repositories;
using Services.DTOs;
using System.Security.Cryptography;
using System.Text;

namespace Services;

/// <summary>
/// User service implementation for business logic
/// </summary>
public class UserService : IUserService
{
    private readonly IUnitOfWork _unitOfWork;

  public UserService(IUnitOfWork unitOfWork)
    {
        _unitOfWork = unitOfWork;
    }

    public async Task<IEnumerable<UserDto>> GetAllUsersAsync()
 {
   var users = await _unitOfWork.UserRepository.GetAllUsersWithRolesAsync();

        return users.Select(u => new UserDto
{
         UserId = u.UserId,
      Username = u.Username,
            FullName = u.FullName,
         Email = u.Email,
  IsActive = u.IsActive,
            CreatedAt = u.CreatedAt,
     Roles = u.Roles.Select(r => r.RoleName).ToList()
        });
    }

    public async Task<UserDto?> GetUserByIdAsync(Guid userId)
    {
        var user = await _unitOfWork.UserRepository.GetUserWithRolesAsync(userId);
        
 if (user == null)
   return null;

        return new UserDto
        {
            UserId = user.UserId,
      Username = user.Username,
FullName = user.FullName,
    Email = user.Email,
 IsActive = user.IsActive,
 CreatedAt = user.CreatedAt,
 Roles = user.Roles.Select(r => r.RoleName).ToList()
        };
    }

    public async Task<UserDto?> GetUserByUsernameAsync(string username)
    {
        var user = await _unitOfWork.UserRepository.GetByUsernameAsync(username);
        
        if (user == null)
            return null;

   return new UserDto
   {
            UserId = user.UserId,
            Username = user.Username,
     FullName = user.FullName,
         Email = user.Email,
      IsActive = user.IsActive,
     CreatedAt = user.CreatedAt,
 Roles = new List<string>()
        };
    }

    public async Task<UserDto> CreateUserAsync(CreateUserDto createUserDto)
    {
      // Validate username doesn't exist
   if (await _unitOfWork.UserRepository.UsernameExistsAsync(createUserDto.Username))
        {
            throw new InvalidOperationException($"Username '{createUserDto.Username}' already exists.");
    }

  // Hash password
      var passwordHash = HashPassword(createUserDto.Password);

   var user = new AppUser
        {
    UserId = Guid.NewGuid(),
  Username = createUserDto.Username,
 PasswordHash = passwordHash,
        FullName = createUserDto.FullName,
        Email = createUserDto.Email,
   IsActive = true,
 CreatedAt = DateTime.UtcNow
        };

        await _unitOfWork.UserRepository.AddAsync(user);
        await _unitOfWork.SaveChangesAsync();

   return new UserDto
        {
   UserId = user.UserId,
       Username = user.Username,
   FullName = user.FullName,
  Email = user.Email,
      IsActive = user.IsActive,
       CreatedAt = user.CreatedAt,
       Roles = new List<string>()
 };
    }

    public async Task<UserDto> UpdateUserAsync(Guid userId, UpdateUserDto updateUserDto)
    {
     var user = await _unitOfWork.UserRepository.GetByIdAsync(userId);

    if (user == null)
        throw new InvalidOperationException($"User with ID '{userId}' not found.");

        user.FullName = updateUserDto.FullName;
        user.Email = updateUserDto.Email;
        user.IsActive = updateUserDto.IsActive;

        _unitOfWork.UserRepository.Update(user);
        await _unitOfWork.SaveChangesAsync();

   return new UserDto
{
      UserId = user.UserId,
  Username = user.Username,
        FullName = user.FullName,
            Email = user.Email,
         IsActive = user.IsActive,
            CreatedAt = user.CreatedAt,
            Roles = new List<string>()
 };
    }

    public async Task<bool> DeleteUserAsync(Guid userId)
    {
  var user = await _unitOfWork.UserRepository.GetByIdAsync(userId);
        
   if (user == null)
       return false;

        _unitOfWork.UserRepository.Delete(user);
        return await _unitOfWork.SaveChangesAsync() > 0;
 }

    public async Task<bool> ChangePasswordAsync(Guid userId, string oldPassword, string newPassword)
    {
        var user = await _unitOfWork.UserRepository.GetByIdAsync(userId);
        
 if (user == null)
       return false;

        // Verify old password
 if (user.PasswordHash == null || !VerifyPassword(oldPassword, user.PasswordHash))
            return false;

        // Hash and update new password
        user.PasswordHash = HashPassword(newPassword);
        _unitOfWork.UserRepository.Update(user);
 
return await _unitOfWork.SaveChangesAsync() > 0;
    }

    // Helper methods for password hashing
    private byte[] HashPassword(string password)
    {
        using var sha256 = SHA256.Create();
        return sha256.ComputeHash(Encoding.UTF8.GetBytes(password));
    }

    private bool VerifyPassword(string password, byte[] hash)
 {
        var computedHash = HashPassword(password);
        return computedHash.SequenceEqual(hash);
    }
}
